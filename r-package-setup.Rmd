---
title: "Create an R package workflow"
output: html_notebook
---

```{r set-up, include=FALSE}
knitr::opts_chunk$set(
  eval = FALSE
)
```


This document shows the set-up steps for a new R package using the {devtools}/{usethis} framework which will include the following features:

 - Version control using git and remote repo hosted on GitHub:
 
   - Automated GitHub actions checks for R CMD build, with README badge
   
   - Automated documentation and code styling with pull requests
 
 - Testing:
 
   - Unit testing using {testthat}
 
   - Automated GitHub actions for code testing coverage using CodeCov and {covr} (includes README badge)
 
 - Internal and external data files
 
 - Documentation:
 
   - {pkgdown} site
   
   - Function and data documentation using {roxygen2}
   
   - README using a .Rmd
   
   - NEWS.md
   
   - Articles and vignettes
   
 - Hex logo
 
 - Code styling using {styler}
 
 
 
The primary reference used is the book [R Packages (2e)](https://r-pkgs.org/) by Hadley Wickham and Jennifer Bryan. Other references include:

 - [{usethis}](https://usethis.r-lib.org/index.html) for package development tools
 
 - [{devtools}](https://devtools.r-lib.org/) and the {devtools} cheatsheet for package development tools
 
 - [{testthat}](https://testthat.r-lib.org/) for unit tests
 
 - [{covr}](https://covr.r-lib.org/) for unit testing automation
 
 - [{roxygen2}](https://roxygen2.r-lib.org/) for documentation
 
 - [{pkgdown}](https://pkgdown.r-lib.org/) for building package websites
 

## Initial Set-up

### 1. Check the package name is available:

```{r}
available::available("sdtmval")
```

Reference: [https://r-pkgs.org/workflow101.html#use-the-available-package](https://r-pkgs.org/workflow101.html#use-the-available-package)

### 2. Create a new directory

```{r}
# dir.create("sdtmval")
```


### 3. Set-up the directory as an R package:

```{r}
create_package("sdtmval")
```

Reference: [https://r-pkgs.org/whole-game.html#create_package](https://r-pkgs.org/whole-game.html#create_package)


## Verion control and repository hosting using git and GitHub

### 4. Set-up local version control

```{r}
use_git()
```

Next, make your first commit using the terminal using the git commands add and commit.

Reference: [https://r-pkgs.org/whole-game.html#use_git](https://r-pkgs.org/whole-game.html#use_git)

### 5. Create a GitHub remote repository

```{r}
# if you did step 5, ignore the first message about uncommitted changes
use_github()
```

Reference: [https://r-pkgs.org/whole-game.html#use_github](https://r-pkgs.org/whole-game.html#use_github)


## Package documentation

### 6. Populate the DESCRIPTION file

Update these fields:
 
 - Title
 
 - Authors (if not automated)
 
 - Description
 
 - Chose a license:

```{r}
use_mit_license()
```

References: 

 - DESCRIPTION file: [https://r-pkgs.org/description.html](https://r-pkgs.org/description.html)
 
 - Licensing: [https://r-pkgs.org/license.html](https://r-pkgs.org/license.html)

### 7. Create a README using Rmarkdown

```{r}
use_readme_rmd()
build_readme()
```

Reference: [https://r-pkgs.org/whole-game.html#use_readme_rmd](https://r-pkgs.org/whole-game.html#use_readme_rmd)

### 8. Create a NEWS file

```{r}
use_news_md()
```

Edit it accordingly. It will be used as a change log for package version releases.

Reference: [https://r-pkgs.org/other-markdown.html#sec-news](https://r-pkgs.org/other-markdown.html#sec-news)

### 9. Create package documentation

This creates a dummy file to establish package level documentation

```{r}
use_package_doc()
```

References:

 - [https://r-pkgs.org/man.html#sec-man-package-doc](https://r-pkgs.org/man.html#sec-man-package-doc)
 

## GitHub Actions

### 10. Use GitHub Actions to automate R CMD check

Every time your push the package to the remote, R CMD check will be run and system compatibility will be check for a variety of OS's. 

```{r}
use_github_action("check-standard")
```

This will also add the R CMD check badge to the README so the README should be re-built:

```{r}
build_readme()
```


Reference: [https://r-pkgs.org/software-development-practices.html#r-cmd-check-via-gha](https://r-pkgs.org/software-development-practices.html#r-cmd-check-via-gha)


### 11. Use GitHub Actions to automate documentation and code styling for pull requests

```{r}
use_github_action("pr-commands")
```


## Functions and their documentation

### 12. Add .R files and Roxygen comments to the R directory

```{r}
use_r("formatting.R")
```

Reference: [https://r-pkgs.org/whole-game.html#use_r](https://r-pkgs.org/whole-game.html#use_r)

### 13. Import packages

As functions from other packages are used (always use the `::` method), add those packages as imports:

```{r}
use_package("dplyr")
```

It's also a good idea to import {magritts}'s pipe operator:

```{r}
use_pipe(export = TRUE)
```


References: 

 - [https://r-pkgs.org/whole-game.html#use_package](https://r-pkgs.org/whole-game.html#use_package)
 
 - [https://usethis.r-lib.org/reference/use_pipe.html](https://usethis.r-lib.org/reference/use_pipe.html)


### 14. Create function documentation

Create {roxygen2} comments using the references below, then build the documetation files by running:

```{r}
document()
```

References:

 - [https://r-pkgs.org/man.html#sec-man-package-doc](https://r-pkgs.org/man.html#sec-man-package-doc)
 
 - [https://r-pkgs.org/man.html](https://r-pkgs.org/man.html)
 
 - [{roxygen2}](https://roxygen2.r-lib.org/)
 

### 15. Articles and vignettes

Use these to provide package instructions and example workflows beyond what is in README.Rmd. Vignettes will be included with your package on install. Articles will not but will be available on the {pkgdown} website. These can be created using the functions:

```{r}
use_vignette("example_vignette")
use_article("example_article")
```

These functions will create then `vignette` and `vignette/articles` directories with its own .gitignore file.
 
Reference: [https://r-pkgs.org/vignettes.html](https://r-pkgs.org/vignettes.html)

## Data (optional)

### 16. Create a exported data file

This will create a file in the `data` directory which will be installed on a user's computer along with the package. Data stored in this manner must be in a native R data format (ie `.rda`).

```{r}
example_data <- c(1, 2, 3)
use_data(example_data)
```

Reference: [https://r-pkgs.org/data.html#sec-data-data](https://r-pkgs.org/data.html#sec-data-data)

### 17. Document a data file

Create a the file `R/data.R` to store documentation for each file in `data`:

```{r}
use_r("data.R")
```

Reference: [https://r-pkgs.org/data.html#sec-documenting-data](https://r-pkgs.org/data.html#sec-documenting-data)

### 18. Set-up raw data directory

This directory, `data-raw` is for files that should not be installed with the rest of the package on a user's computer. It is used to prepare data in the `data` directory that may be in another format or multiple different files that need consolidating or pre-processing. The function below will create an R script named `example.R` where you can run code to prepare package data files from raw data files.

```{r}
use_data_raw("example.R")
```

Reference: [https://r-pkgs.org/data.html#sec-data-data-raw](https://r-pkgs.org/data.html#sec-data-data-raw)

### 19. Create package internal data

Internal package data, similar to data stored in `data-raw`. will not be shared with the end users of the package. All internal data is stored in the R object `R/sysdata.rda`. You can create a script to create this object in `data-raw` like this:

```{r}
use_data_raw("internal")
```

Then inside that script, create something like:

```{r}
int1 <- 1
int2 <- "a"
usethis::use_data(int1, int2, overwrite = TRUE, internal = TRUE)
```

Reference: [https://r-pkgs.org/data.html#sec-data-sysdata](https://r-pkgs.org/data.html#sec-data-sysdata)

### 20. Use non-R data files

Any non-R data files needed for examples that you want the user to have access to after installation should be stored in `inst/extdata`. They can be created under `data-raw` but should not call `usethis::use_data()`.

Reference: [https://r-pkgs.org/data.html#sec-data-extdata](https://r-pkgs.org/data.html#sec-data-extdata)

## Testing

### 21. Set-up {testthat}

```{r}
use_testthat()
```

Reference: [https://r-pkgs.org/testing-basics.html#initial-setup](https://r-pkgs.org/testing-basics.html#initial-setup)

### 22. Write and run tests

Create 1 test script for each file in `R` that you want to test:

```{r}
use_test("formatting.R")
```

Populate the file according to the {testthat} convention.

You can run individual test functions inside a test file. Make sure to always run `devtools::load_all()` first and after making any change to the file being tested.

You can run all tests for a file in `R` using (the `setwd()` call is just for the purposes of this notebook:

```{r}
test_file("R/formatting.R")
```

Test the entire package by running:

```{r}
test()
```

You can include test helpers in a `.R` file below `tests/testthat`.  You can also include files (test fixtures) be adding the director `tests/testthat/fixtures`.

References:

 - [https://r-pkgs.org/testing-basics.html#sec-tests-mechanics-workflow](https://r-pkgs.org/testing-basics.html#sec-tests-mechanics-workflow)
 
 - [{testthat}](https://testthat.r-lib.org/)
 
 - [https://r-pkgs.org/testing-advanced.html#test-fixtures](https://r-pkgs.org/testing-advanced.html#test-fixtures)
 

### 23. Track test coverage using {covr} and CodeCov.io

Prepare the testing coverage framework for CodeCov:

```{r}
use_coverage(type = "codecov")
```

The code above will also add a CodeCov badge the README so the README must be re-built:

```{r}
build_readme()
```


Check the test coverage for the package using:

```{r}
# this will produce a report in R Studio's View window
covr::report()

# alternatively, this will print the results to the console
covr::package_coverage()
```

This code will test an individual file:

```{r}
# this will print a report in the console
covr::file_coverage("../R/formatting.R", "../tests/testthat/test-formatting.R")

# or run devtools::test_coverage_active_file() for a better report in the Viewer
```

Next, link the GitHub repo to CodeCov by signing into CodeCov, selecting the correct repo, and following the steps for GitHub Actions set-up. This will involve copy a token from CodeCov and copying into a GitHub repo secret. Note the GitHub report must be public to do this part. 

Finally, add test coverage as a GitHub actions workflow:

```{r}
use_github_action("test-coverage")
```

References:

 - [https://usethis.r-lib.org/reference/use_coverage.html](https://usethis.r-lib.org/reference/use_coverage.html)
 
 - [{covr}](https://covr.r-lib.org/) for unit testing automation
 
 - [https://r-pkgs.org/testing-design.html#sec-testing-design-coverage](https://r-pkgs.org/testing-design.html#sec-testing-design-coverage)


## Website

### 24. Set-up a {pkgdown} website 

In this case, GitHub pages will be used. Every time you push to the remote, the website will be re-built.

```{r}
use_pkgdown_github_pages()
```

To initially create the files for building the site locally run:

```{r}
pkgdown::build_site()
```

To locally preview sections of the site run one of the `pkgdown::build_*()` functions.

By default the reference page will list package functions in alphabetical order. To customize this page and group packages into sections, see: [https://pkgdown.r-lib.org/reference/build_reference.html?q=subtitle#reference-index](https://pkgdown.r-lib.org/reference/build_reference.html?q=subtitle#reference-index)

References:

 - [https://r-pkgs.org/website.html#sec-website-deployment](https://r-pkgs.org/website.html#sec-website-deployment)
 
 - [{pkgdown}](https://pkgdown.r-lib.org/)
 
 - [https://pkgdown.r-lib.org/reference/build_reference.html?q=subtitle#reference-index](https://pkgdown.r-lib.org/reference/build_reference.html?q=subtitle#reference-index)

## Logo

### 25. Create a hex logo

Design and download your logo using [hexmake](https://connect.thinkr.fr/hexmake/). Use [flaticon.com](https://www.flaticon.com/) for the icon inside the hex logo if you wish. 

Implement using:

```{r}
use_logo("[PATH TO LOGO]")
```

The code ran in the previous chunk will add html code to your clipboard. Paste that into README.Rmd where the title is. Then rebuild the README:

```{r}
build_readme()
```

Reference: [https://r-pkgs.org/website.html#logo](https://r-pkgs.org/website.html#logo)


## Code Styling

### 26. Apply code styling using the {styler} package

```{r}
# style the code using {styler}
use_tidy_style()
```


## Post set-up workflow

After the above set-up steps are complete the iterative workflow steps are generally to load the current package, test it, document it, and run R CMD check. After which, run the git commands add, commit, and push.

Test:

```{r}
load_all()
test()
```

Document:

```{r}
# style the code using {styler}
use_tidy_style()

# changes to the README were made
build_readme()

# document using {roxygen2}
document()
```

R CMD check:

```{r}
check()
```

Finally, run the standard git commands to push your changes to the remote (add, commit, push).

Reference: [{devtools} cheatsheet](https://devtools.r-lib.org/)




















